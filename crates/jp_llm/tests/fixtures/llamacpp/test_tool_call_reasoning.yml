when:
  path: /chat/completions
  method: POST
  json_body_str: >-
    {
      "model": "llama3:latest",
      "messages": [
        {
          "role": "user",
          "content": "Please run the tool, providing whatever arguments you want."
        }
      ],
      "stream": true,
      "tools": [
        {
          "type": "function",
          "function": {
            "name": "run_me",
            "description": "",
            "parameters": {
              "type": "object",
              "properties": {
                "foo": {
                  "type": "string",
                  "default": "foo"
                },
                "bar": {
                  "type": [
                    "string",
                    "array"
                  ],
                  "enum": [
                    "foo"
                  ],
                  "items": {
                    "type": "string",
                    "enum": [
                      "foo",
                      "bar"
                    ]
                  }
                }
              },
              "additionalProperties": true,
              "required": [
                "bar"
              ]
            },
            "strict": false
          }
        }
      ],
      "tool_choice": "auto"
    }
then:
  status: 200
  header:
    - name: content-type
      value: text/event-stream
  body: |+
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"role":"assistant","content":null}}],"created":1766136311,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"id":"sF2ivmYeu2EZ66osbn1c9HEWVWcwECw2","type":"function","function":{"name":"run_me","arguments":""}}]}}],"created":1766136311,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"{\""}}]}}],"created":1766136311,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"bar"}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\":"}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\""}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"foo"}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\","}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\""}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"foo"}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\":"}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\""}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"test"}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"_value"}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"tool_calls":[{"index":0,"function":{"arguments":"\"}"}}]}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":"tool_calls","index":0,"delta":{}}],"created":1766136312,"id":"chatcmpl-UuVE1CaXFOKHIWi4DirWvPLEVXWme3sv","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk","usage":{"completion_tokens":27,"prompt_tokens":216,"total_tokens":243},"timings":{"prompt_n":1,"prompt_ms":19.613,"prompt_per_token_ms":19.613,"prompt_per_second":50.98659052669148,"predicted_n":27,"predicted_ms":511.957,"predicted_per_token_ms":18.96137037037037,"predicted_per_second":52.73880423551197}}
    
    data: [DONE]
    
---
when:
  path: /chat/completions
  method: POST
  json_body_str: >-
    {
      "model": "llama3:latest",
      "messages": [
        {
          "role": "user",
          "content": "Please run the tool, providing whatever arguments you want."
        },
        {
          "role": "assistant",
          "content": null,
          "tool_calls": [
            {
              "id": "sF2ivmYeu2EZ66osbn1c9HEWVWcwECw2",
              "type": "function",
              "function": {
                "name": "run_me",
                "arguments": "{\"bar\":\"foo\",\"foo\":\"test_value\"}"
              }
            }
          ]
        },
        {
          "role": "tool",
          "content": "working!",
          "tool_call_id": "sF2ivmYeu2EZ66osbn1c9HEWVWcwECw2"
        }
      ],
      "stream": true,
      "tool_choice": "auto"
    }
then:
  status: 200
  header:
    - name: content-type
      value: text/event-stream
  body: |+
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"role":"assistant","content":null}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"It"}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" looks"}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" like"}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" the"}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" tool"}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" executed"}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" successfully"}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"!"}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" Here"}}],"created":1766136319,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"'s"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" the"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" response"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":":\n\n"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"``"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"`\n"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"working"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"!\n"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"``"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"`\n\n"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"Is"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" there"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" anything"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" specific"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" you"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" want"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" to"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" do"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" next"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" or"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" any"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" other"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" tools"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" you"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"'d"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" like"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" to"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":" run"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":null,"index":0,"delta":{"content":"?"}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk"}
    
    data: {"choices":[{"finish_reason":"stop","index":0,"delta":{}}],"created":1766136320,"id":"chatcmpl-GXhgbuCz33rtFjGMNH0cGJVSA0Y77mWR","model":"llama3:latest","system_fingerprint":"b5740-fa4a9f2a","object":"chat.completion.chunk","usage":{"completion_tokens":39,"prompt_tokens":86,"total_tokens":125},"timings":{"prompt_n":23,"prompt_ms":104.068,"prompt_per_token_ms":4.524695652173913,"prompt_per_second":221.00934004689242,"predicted_n":39,"predicted_ms":1055.613,"predicted_per_token_ms":27.067,"predicted_per_second":36.945357815790445}}
    
    data: [DONE]
    
